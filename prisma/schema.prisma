// Dorm Management - Prisma Schema
// Run: npx prisma migrate dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// Resident / student in the dorm
model User {
  id        String   @id @default(cuid())
  name      String
  phone     String   @default("")
  building  String   @default("")
  floor     String   @default("")
  room      String   @default("")
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  requests      MaintenanceRequest[]
  notifications Notification[]
}

// Maintenance technician
model Technician {
  id        String   @id @default(cuid())
  name      String
  phone     String   @default("")
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  assignedRequests   MaintenanceRequest[] @relation("AssignedTechnician")
  declinedRequests   RequestDecline[]
}

// Admin-created announcements (no FK; admin is config-based)
model Announcement {
  id        String   @id @default(cuid())
  title     String
  body      String
  createdAt DateTime @default(now())
}

// Maintenance request from a user
model MaintenanceRequest {
  id                     String   @id @default(cuid())
  userId                 String
  title                  String
  description            String
  status                 String   @default("pending") // pending | in_progress | complete
  priority               String   @default("medium")  // urgent | medium | low | enhancement
  assignedTechnicianId   String?
  acceptedByTechnician   Boolean  @default(false)
  technicianNotes        String   @default("")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedTechnician Technician?    @relation("AssignedTechnician", fields: [assignedTechnicianId], references: [id], onDelete: SetNull)
  declinedBy       RequestDecline[]
  notifications   Notification[]
}

// Technician declined this request (admin can reassign)
model RequestDecline {
  id             String   @id @default(cuid())
  requestId      String
  technicianId   String
  createdAt      DateTime @default(now())

  request    MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  technician Technician        @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([requestId, technicianId])
}

// Notification for a user about a request
model Notification {
  id        String   @id @default(cuid())
  userId    String
  requestId String
  type      String   // technician_accept | status_update | request_created | assigned
  title     String
  message   String
  createdAt DateTime @default(now())

  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  request MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
}
